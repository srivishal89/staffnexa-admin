<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staffnexa â€“ Candidate Applications</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
body { font-family: 'Inter', sans-serif; }

.custom-checkbox {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    cursor: pointer;
}
.custom-checkbox:checked {
    background-color: #4f46e5;
}
</style>
</head>

<body class="bg-slate-50 text-slate-800 flex h-screen">

<!-- SIDEBAR -->
<aside class="w-64 bg-white border-r hidden md:flex flex-col">
    <div class="p-6 font-bold text-xl text-indigo-600">Staffnexa</div>

    <nav class="flex-1 px-4">
        <a class="block py-2 text-indigo-600 font-semibold">Candidates</a>
    </nav>

    <div class="p-4">
        <button onclick="logout()" class="w-full bg-red-600 text-white py-2 rounded-lg">
            Logout
        </button>
    </div>
</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col overflow-hidden">

<!-- HEADER -->
<header class="bg-white border-b px-6 py-4 flex justify-between">
    <h1 class="text-xl font-semibold">Candidate Applications</h1>
</header>

<!-- CONTENT -->
<div class="p-6 overflow-auto">

<!-- STATS -->
<div class="grid md:grid-cols-3 gap-4 mb-6">

<div class="bg-white p-4 rounded-xl shadow border">
<p class="text-sm text-gray-500">Total</p>
<p id="total-count" class="text-2xl font-bold text-indigo-600">0</p>
</div>

<div class="bg-white p-4 rounded-xl shadow border">
<p class="text-sm text-gray-500">Filtered</p>
<p id="showingCount" class="text-2xl font-bold text-blue-600">0</p>
</div>

<div class="bg-white p-4 rounded-xl shadow border">
<p class="text-sm text-gray-500">Selected</p>
<p id="selectedCount" class="text-2xl font-bold text-rose-600">0</p>
</div>

</div>

<!-- FILTER BAR -->
<div class="bg-white p-4 rounded-xl shadow border mb-4 flex flex-wrap gap-3 items-center">

<input id="searchInput"
    placeholder="Search name or phone"
    class="border px-3 py-2 rounded-lg w-full md:w-1/3">

<select id="roleFilter" class="border px-3 py-2 rounded-lg">
    <option value="">Role</option>
    <option>Supervisor</option>
    <option>Housekeeping</option>
    <option>Manager</option>
    <option>Security</option>
</select>

<select id="locationFilter" class="border px-3 py-2 rounded-lg">
    <option value="">Location</option>
    <option>Noida</option>
    <option>Delhi</option>
    <option>Gurgaon</option>
</select>

<!-- RIGHT SIDE BUTTONS -->
<div class="ml-auto flex gap-2">
    <button onclick="exportData()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">
        Export
    </button>
    <button onclick="deleteSelected()" class="bg-rose-600 text-white px-4 py-2 rounded-lg">
        Delete
    </button>
</div>

</div>

<!-- TABLE -->
<div class="bg-white rounded-xl shadow border overflow-x-auto">

<table class="w-full text-sm">

<thead class="bg-indigo-50 text-indigo-700 uppercase text-xs">
<tr>
<th class="p-4 text-left"><input type="checkbox" id="selectAll"></th>
<th class="p-4 text-left">Name</th>
<th class="p-4 text-left">Phone</th>
<th class="p-4 text-left">Role</th>
<th class="p-4 text-left">Location</th>
<th class="p-4 text-left">Date</th>
<th class="p-4 text-right">Resume</th>
</tr>
</thead>

<tbody id="tableBody" class="divide-y"></tbody>

</table>

</div>

</div>
</main>

<script>

const API_BASE = "https://staffnexa-backend.onrender.com";
const API = API_BASE + "/candidates";

const token = localStorage.getItem("adminAuth");

if (!token) window.location.href = "index.html";

let candidates = [];
let selectedIds = new Set();

const tableBody = document.getElementById("tableBody");
const searchInput = document.getElementById("searchInput");
const roleFilter = document.getElementById("roleFilter");
const locationFilter = document.getElementById("locationFilter");
const selectAll = document.getElementById("selectAll");

// FETCH DATA
async function fetchCandidates() {
    try {
        const res = await fetch(API, {
            headers: { "Authorization": "Basic " + token }
        });

        if (res.status === 401) logout();

        const data = await res.json();

        candidates = data.map(c => ({
            id: c._id,
            name: c.name || "",
            phone: c.phone || "",
            role: c.role || "",
            location: c.location || "",
            date: new Date(c.createdAt).toLocaleString(),
            resume: c.resume || "" // IMPORTANT
        }));

        renderTable();

    } catch (err) {
        console.log(err);
        alert("Error loading data");
    }
}

// RENDER
function renderTable() {

    const search = searchInput.value.toLowerCase();
    const role = roleFilter.value;
    const location = locationFilter.value;

    const filtered = candidates.filter(c =>
        (c.name.toLowerCase().includes(search) || c.phone.includes(search)) &&
        (!role || c.role === role) &&
        (!location || c.location === location)
    );

    tableBody.innerHTML = "";

    if (!filtered.length) {
        tableBody.innerHTML = "<tr><td colspan='7' class='p-6 text-center'>No Data</td></tr>";
    }

    filtered.forEach(c => {

        const tr = document.createElement("tr");
        tr.className = "hover:bg-indigo-50";

        tr.innerHTML = `
        <td class="p-4">
            <input type="checkbox" class="rowCheck" data-id="${c.id}" ${selectedIds.has(c.id) ? "checked":""}>
        </td>
        <td class="p-4 font-medium">${c.name}</td>
        <td class="p-4 text-gray-600">${c.phone}</td>
        <td class="p-4">
            <span class="px-2 py-1 rounded bg-indigo-100 text-indigo-700 text-xs">
                ${c.role}
            </span>
        </td>
        <td class="p-4">${c.location}</td>
        <td class="p-4 text-gray-500">${c.date}</td>
        <td class="p-4 text-right">
            ${c.resume ? `<a href="${c.resume}" target="_blank" class="text-indigo-600 hover:underline">Download</a>` : "-"}
        </td>
        `;

        tableBody.appendChild(tr);
    });

    document.getElementById("total-count").innerText = candidates.length;
    document.getElementById("showingCount").innerText = filtered.length;
    document.getElementById("selectedCount").innerText = selectedIds.size;

    document.querySelectorAll(".rowCheck").forEach(cb => {
        cb.onchange = function() {
            const id = this.dataset.id;
            this.checked ? selectedIds.add(id) : selectedIds.delete(id);
            renderTable();
        };
    });
}

// SELECT ALL
selectAll.onchange = function() {
    document.querySelectorAll(".rowCheck").forEach(cb => {
        cb.checked = selectAll.checked;
        const id = cb.dataset.id;
        selectAll.checked ? selectedIds.add(id) : selectedIds.delete(id);
    });
    renderTable();
};

// FILTER EVENTS
searchInput.oninput = renderTable;
roleFilter.onchange = renderTable;
locationFilter.onchange = renderTable;

// EXPORT
function exportData() {
    if (!selectedIds.size) return alert("Select records");

    const data = candidates.filter(c => selectedIds.has(c.id));

    const csv = [
        ["Name","Phone","Role","Location","Date"],
        ...data.map(d => [d.name,d.phone,d.role,d.location,d.date])
    ].map(e => e.join(",")).join("\n");

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "candidates.csv";
    a.click();
}

// DELETE
async function deleteSelected() {

    if (!selectedIds.size) return alert("Select records");
    if (!confirm("Delete selected?")) return;

    try {
        for (let id of selectedIds) {
            await fetch(API_BASE + "/candidates/" + id, {
                method: "DELETE",
                headers: { "Authorization": "Basic " + token }
            });
        }

        selectedIds.clear();
        fetchCandidates();

    } catch (e) {
        alert("Delete failed");
    }
}

// LOGOUT
function logout() {
    localStorage.removeItem("adminAuth");
    window.location.href = "index.html";
}

// INIT
fetchCandidates();

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staffnexa Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<div class="p-6">

    <h1 class="text-2xl font-bold mb-4">Candidate Applications</h1>

    <div class="bg-white p-4 rounded shadow">

        <table class="w-full border">
            <thead>
                <tr class="bg-gray-200">
                    <th class="p-3">Name</th>
                    <th class="p-3">Phone</th>
                    <th class="p-3">Role</th>
                    <th class="p-3">Location</th>
                    <th class="p-3">Date</th>
                    <th class="p-3">Action</th>
                </tr>
            </thead>

            <tbody id="tableBody">
                <tr>
                    <td colspan="6" class="p-4 text-center">Loading...</td>
                </tr>
            </tbody>
        </table>

    </div>

</div>

<script>
const API_BASE = "https://staffnexa-backend.onrender.com";

let candidates = [];

// ===== AUTH =====
function getToken() {
    const token = localStorage.getItem("adminAuth");

    if (!token) {
        window.location.href = "index.html";
        return null;
    }

    return token;
}

// ===== FETCH =====
async function fetchCandidates() {
    const token = getToken();
    if (!token) return;

    try {
        const res = await fetch(`${API_BASE}/candidates`, {
            headers: {
                "Authorization": "Basic " + token
            }
        });

        if (!res.ok) {
            throw new Error("Unauthorized");
        }

        const json = await res.json();

        console.log("API DATA:", json);

        let dataArray = Array.isArray(json) ? json : json.data;

        if (!dataArray) throw new Error("Invalid data");

        candidates = dataArray.map(c => ({
            id: c._id,
            name: c.name || "N/A",
            phone: c.phone || "",
            role: c.jobRole || "",
            location: c.location || "",
            date: c.createdAt ? new Date(c.createdAt).toLocaleString() : "-"
        }));

        renderTable();

    } catch (err) {
        console.error(err);

        document.getElementById("tableBody").innerHTML = `
            <tr>
                <td colspan="6" class="p-4 text-center text-red-500">
                    Failed to load data
                </td>
            </tr>
        `;
    }
}

// ===== RENDER =====
function renderTable() {
    const tableBody = document.getElementById("tableBody");

    if (!tableBody) {
        console.error("tableBody not found");
        return;
    }

    tableBody.innerHTML = "";

    if (!candidates.length) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="p-4 text-center">
                    No data found
                </td>
            </tr>
        `;
        return;
    }

    candidates.forEach(c => {
        tableBody.innerHTML += `
            <tr class="border-b">
                <td class="p-3">${c.name}</td>
                <td class="p-3">${c.phone}</td>
                <td class="p-3">${c.role}</td>
                <td class="p-3">${c.location}</td>
                <td class="p-3">${c.date}</td>
                <td class="p-3">
                    <button onclick="deleteCandidate('${c.id}')" class="text-red-600">
                        Delete
                    </button>
                </td>
            </tr>
        `;
    });
}

// ===== DELETE =====
async function deleteCandidate(id) {
    if (!confirm("Delete this candidate?")) return;

    const token = getToken();

    await fetch(`${API_BASE}/candidates/${id}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Basic " + token
        }
    });

    fetchCandidates();
}

// ===== INIT =====
window.onload = fetchCandidates;
</script>

</body>
</html>

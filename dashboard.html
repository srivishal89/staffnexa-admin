<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staffnexa â€“ Candidate Applications</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
body { font-family: sans-serif; }
.custom-checkbox {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    cursor: pointer;
}
.custom-checkbox:checked { background: #4f46e5; }
</style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="hidden md:flex flex-col w-64 bg-white border-r">
    <div class="p-6 font-bold text-xl">Staffnexa</div>

    <nav class="flex-1 p-4 space-y-2">
        <a class="block text-indigo-600 font-semibold">Candidates</a>
    </nav>

    <div class="p-4 border-t">
        <button onclick="logout()" class="w-full bg-red-600 text-white py-2 rounded">Logout</button>
    </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">

<header class="bg-white border-b p-4 flex justify-between">
    <h1 class="text-xl font-semibold">Candidate Applications</h1>
</header>

<div class="p-6">

<!-- Stats -->
<div class="grid grid-cols-3 gap-4 mb-6">
    <div class="bg-white p-4 rounded shadow">
        <p>Total</p>
        <h2 id="total-count" class="text-2xl font-bold">0</h2>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <p>Filtered</p>
        <h2 id="showingCount" class="text-2xl font-bold">0</h2>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <p>Selected</p>
        <h2 id="selectedCount" class="text-2xl font-bold">0</h2>
    </div>
</div>

<!-- Filters -->
<div class="bg-white p-4 rounded shadow mb-4 flex gap-4">

<input id="searchInput" placeholder="Search name or phone"
    class="border px-3 py-2 rounded w-1/3">

<select id="roleFilter" class="border px-3 py-2 rounded">
    <option value="">Role</option>
    <option>Supervisor</option>
    <option>Housekeeping</option>
    <option>Manager</option>
    <option>Security</option>
</select>

<select id="locationFilter" class="border px-3 py-2 rounded">
    <option value="">Location</option>
    <option>Noida</option>
    <option>Delhi</option>
    <option>Gurgaon</option>
</select>

<button onclick="exportData()" class="bg-blue-600 text-white px-4 py-2 rounded">Export</button>
<button onclick="deleteSelected()" class="bg-red-600 text-white px-4 py-2 rounded">Delete</button>

</div>

<!-- Table -->
<div class="bg-white rounded shadow overflow-auto">
<table class="w-full">

<thead class="bg-gray-100">
<tr>
<th class="p-3"><input type="checkbox" id="selectAll"></th>
<th class="p-3">Name</th>
<th class="p-3">Phone</th>
<th class="p-3">Role</th>
<th class="p-3">Location</th>
<th class="p-3">Date</th>
</tr>
</thead>

<tbody id="tableBody"></tbody>

</table>
</div>

</div>
</main>

<script>

const API_BASE = "https://staffnexa-backend.onrender.com";
const API = API_BASE + "/candidates";

const token = localStorage.getItem("adminAuth");

if (!token) window.location.href = "index.html";

let candidates = [];
let selectedIds = new Set();

const tableBody = document.getElementById("tableBody");
const searchInput = document.getElementById("searchInput");
const roleFilter = document.getElementById("roleFilter");
const locationFilter = document.getElementById("locationFilter");
const selectAll = document.getElementById("selectAll");

// FETCH
async function fetchCandidates() {
    try {
        const res = await fetch(API, {
            headers: { "Authorization": "Basic " + token }
        });

        if (res.status === 401) logout();

        const data = await res.json();

        candidates = data.map(c => ({
            id: c._id,
            name: c.name || "",
            phone: c.phone || "",
            role: c.role || "",
            location: c.location || "",
            date: new Date(c.createdAt).toLocaleString()
        }));

        renderTable();

    } catch (err) {
        alert("Error loading data");
        console.log(err);
    }
}

// RENDER
function renderTable() {

    const search = searchInput.value.toLowerCase();
    const role = roleFilter.value;
    const location = locationFilter.value;

    const filtered = candidates.filter(c =>
        (c.name.toLowerCase().includes(search) || c.phone.includes(search)) &&
        (!role || c.role === role) &&
        (!location || c.location === location)
    );

    tableBody.innerHTML = "";

    filtered.forEach(c => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
        <td class="p-3">
            <input type="checkbox" class="rowCheck" data-id="${c.id}" ${selectedIds.has(c.id) ? "checked":""}>
        </td>
        <td class="p-3">${c.name}</td>
        <td class="p-3">${c.phone}</td>
        <td class="p-3">${c.role}</td>
        <td class="p-3">${c.location}</td>
        <td class="p-3">${c.date}</td>
        `;

        tableBody.appendChild(tr);
    });

    // counts
    document.getElementById("total-count").innerText = candidates.length;
    document.getElementById("showingCount").innerText = filtered.length;
    document.getElementById("selectedCount").innerText = selectedIds.size;

    // checkbox logic
    document.querySelectorAll(".rowCheck").forEach(cb => {
        cb.onchange = function() {
            const id = this.dataset.id;
            this.checked ? selectedIds.add(id) : selectedIds.delete(id);
            renderTable();
        };
    });
}

// select all
selectAll.onchange = function() {
    const visible = document.querySelectorAll(".rowCheck");
    visible.forEach(cb => {
        cb.checked = selectAll.checked;
        const id = cb.dataset.id;
        selectAll.checked ? selectedIds.add(id) : selectedIds.delete(id);
    });
    renderTable();
};

// filters
searchInput.oninput = renderTable;
roleFilter.onchange = renderTable;
locationFilter.onchange = renderTable;

// EXPORT
function exportData() {
    if (!selectedIds.size) return alert("Select records");

    const data = candidates.filter(c => selectedIds.has(c.id));

    const csv = [
        ["Name","Phone","Role","Location","Date"],
        ...data.map(d => [d.name,d.phone,d.role,d.location,d.date])
    ].map(e => e.join(",")).join("\n");

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "candidates.csv";
    a.click();
}

// DELETE
async function deleteSelected() {

    if (!selectedIds.size) return alert("Select records");

    if (!confirm("Delete selected?")) return;

    try {
        for (let id of selectedIds) {
            await fetch(API_BASE + "/candidates/" + id, {
                method: "DELETE",
                headers: { "Authorization": "Basic " + token }
            });
        }

        selectedIds.clear();
        fetchCandidates();

    } catch (e) {
        alert("Delete failed");
    }
}

// LOGOUT
function logout() {
    localStorage.removeItem("adminAuth");
    window.location.href = "index.html";
}

// INIT
fetchCandidates();

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staffnexa â€“ Candidate Applications</title>

<script src="https://cdn.tailwindcss.com"></script>

</head>

<body class="bg-slate-50 flex h-screen">

<!-- SIDEBAR -->
<aside class="w-64 bg-white border-r hidden md:flex flex-col">

<div class="p-6 flex items-center gap-3">
    <img src="logo.png" class="w-8 h-8">
    <span class="font-bold text-lg text-indigo-600">Staffnexa</span>
</div>

<nav class="flex-1 px-4">
    <a class="block py-2 text-indigo-600 font-semibold">Candidates</a>
</nav>

<div class="p-4">
    <button onclick="logout()" class="w-full bg-red-600 text-white py-2 rounded-lg">
        Logout
    </button>
</div>

</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col overflow-hidden">

<header class="bg-white border-b px-6 py-4">
    <h1 class="text-xl font-semibold">Candidate Applications</h1>
</header>

<div class="p-6 overflow-auto">

<!-- STATS -->
<div class="grid md:grid-cols-3 gap-4 mb-6">
<div class="bg-white p-4 rounded-xl shadow border">
<p>Total</p><p id="total-count" class="text-xl font-bold text-indigo-600">0</p>
</div>
<div class="bg-white p-4 rounded-xl shadow border">
<p>Filtered</p><p id="showingCount" class="text-xl font-bold text-blue-600">0</p>
</div>
<div class="bg-white p-4 rounded-xl shadow border">
<p>Selected</p><p id="selectedCount" class="text-xl font-bold text-rose-600">0</p>
</div>
</div>

<!-- FILTER -->
<div class="bg-white p-4 rounded-xl shadow border mb-4 flex gap-3 items-center flex-wrap">

<input id="searchInput" placeholder="Search name or phone"
class="border px-3 py-2 rounded-lg w-full md:w-1/3">

<select id="roleFilter" class="border px-3 py-2 rounded-lg">
<option value="">Role</option>
<option>Supervisor</option>
<option>Housekeeping</option>
<option>Manager</option>
<option>Security</option>
</select>

<select id="locationFilter" class="border px-3 py-2 rounded-lg">
<option value="">Location</option>
<option>Noida</option>
<option>Delhi</option>
<option>Gurgaon</option>
</select>

<div class="ml-auto flex gap-2">
<button onclick="exportData()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Export</button>
<button onclick="deleteSelected()" class="bg-rose-600 text-white px-4 py-2 rounded-lg">Delete</button>
</div>

</div>

<!-- TABLE -->
<div class="bg-white rounded-xl shadow border overflow-x-auto">

<table class="w-full text-sm">

<thead class="bg-indigo-50 text-indigo-700 text-xs uppercase">
<tr>
<th class="p-4"><input type="checkbox" id="selectAll"></th>
<th class="p-4 text-left">Name</th>
<th class="p-4 text-left">Phone</th>
<th class="p-4 text-left">Role</th>
<th class="p-4 text-left">Location</th>
<th class="p-4 text-left">Date</th>
<th class="p-4 text-right">Resume</th>
</tr>
</thead>

<tbody id="tableBody"></tbody>

</table>

</div>

</div>
</main>

<script>

const API_BASE = "https://staffnexa-backend.onrender.com";
const token = localStorage.getItem("adminAuth");

if (!token) window.location.href = "index.html";

let candidates = [];
let selectedIds = new Set();

const tableBody = document.getElementById("tableBody");

// ðŸ”¥ FIXED RESUME HANDLER
function getResumeUrl(resume) {
    if (!resume) return "";

    // case 1: string URL
    if (typeof resume === "string") return resume;

    // case 2: object with url
    if (resume.url) return resume.url;

    // case 3: object with path
    if (resume.path) return API_BASE + "/" + resume.path;

    // case 4: multer file
    if (resume.filename) return API_BASE + "/uploads/" + resume.filename;

    return "";
}

// FETCH
async function fetchCandidates() {
    try {
        const res = await fetch(API_BASE + "/candidates", {
            headers: { "Authorization": "Basic " + token }
        });

        const data = await res.json();

        candidates = data.map(c => ({
            id: c._id,
            name: c.name || "",
            phone: c.phone || "",
            role: c.role || "",
            location: c.location || "",
            date: new Date(c.createdAt).toLocaleString(),
            resume: getResumeUrl(c.resume || c.resumeUrl || c.file || c.attachment)
        }));

        renderTable();

    } catch (e) {
        console.log(e);
        alert("Error loading data");
    }
}

// RENDER
function renderTable() {

    const search = document.getElementById("searchInput").value.toLowerCase();
    const role = document.getElementById("roleFilter").value;
    const location = document.getElementById("locationFilter").value;

    const filtered = candidates.filter(c =>
        (c.name.toLowerCase().includes(search) || c.phone.includes(search)) &&
        (!role || c.role === role) &&
        (!location || c.location === location)
    );

    tableBody.innerHTML = "";

    filtered.forEach(c => {

        const tr = document.createElement("tr");
        tr.className = "hover:bg-indigo-50";

        tr.innerHTML = `
        <td class="p-4"><input type="checkbox" class="rowCheck" data-id="${c.id}"></td>
        <td class="p-4">${c.name}</td>
        <td class="p-4">${c.phone}</td>
        <td class="p-4"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs">${c.role}</span></td>
        <td class="p-4">${c.location}</td>
        <td class="p-4">${c.date}</td>
        <td class="p-4 text-right">
            ${c.resume ? `<a href="${c.resume}" target="_blank" class="text-indigo-600 hover:underline">Download</a>` : "-"}
        </td>
        `;

        tableBody.appendChild(tr);
    });

    document.getElementById("total-count").innerText = candidates.length;
    document.getElementById("showingCount").innerText = filtered.length;
}

// LOGOUT
function logout() {
    localStorage.removeItem("adminAuth");
    window.location.href = "index.html";
}

// INIT
fetchCandidates();

</script>

</body>
</html>
